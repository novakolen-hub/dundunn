<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0e14">
<title>V9 Trading Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#0b0e14;color:#c4cad4;font-family:'DM Sans',-apple-system,sans-serif;font-size:14px;line-height:1.55;padding:12px;max-width:720px;margin:0 auto;-webkit-text-size-adjust:100%}
  h1{font-family:'JetBrains Mono',monospace;color:#58a6ff;font-size:17px;letter-spacing:-0.3px;padding-bottom:8px;margin-bottom:10px;border-bottom:1px solid #1c2333}
  h2{color:#e6edf3;font-size:15px;font-weight:700;margin-top:22px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
  h2::before{content:'';width:3px;height:16px;background:#58a6ff;border-radius:2px;flex-shrink:0}
  h3{color:#7d8590;font-size:11px;font-weight:700;margin-top:14px;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
  p{margin-bottom:8px}a{color:#58a6ff;text-decoration:none}
  .g{color:#3fb950}.r{color:#f85149}.y{color:#d29922}.b{color:#58a6ff}.dim{color:#7d8590}.bold{font-weight:700}.white{color:#e6edf3}
  .mono{font-family:'JetBrains Mono',monospace}
  .tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700}
  .tag-gp{font-family:'JetBrains Mono',monospace;font-size:13px;padding:5px 14px;border-radius:6px}
  .tag-gp-a{background:#0d2818;color:#00C853;border:1px solid #00C853}
  .tag-gp-b{background:#0d1a2e;color:#2196F3;border:1px solid #2196F3}
  .tag-gp-c{background:#1f1a0f;color:#FF9800;border:1px solid #FF9800}
  .tag-gp-d{background:#1f1315;color:#F44336;border:1px solid #F44336}
  .tag-live{background:#0d2818;color:#3fb950;border:1px solid #238636;font-size:10px;padding:1px 6px}
  .tag-acct{background:#161b22;color:#7d8590;border:1px solid #30363d;font-size:10px;padding:1px 6px}
  .gp-box{background:linear-gradient(135deg,#0f1923 0%,#131d2b 100%);border:1px solid #1c2333;padding:14px 16px;border-radius:8px;margin-bottom:6px}
  .story-box{background:#0f1318;border-left:3px solid #58a6ff;padding:12px 16px;margin:8px 0;border-radius:0 6px 6px 0;font-size:13px;line-height:1.7}
  .info-box{background:#0f1318;border:1px solid #1c2333;padding:12px 16px;border-radius:6px;margin:8px 0}
  .warn-box{background:#1f1315;border-left:3px solid #f85149;padding:10px 16px;margin:8px 0;border-radius:0 6px 6px 0}
  .alert-box{background:#0f1318;border-left:3px solid #d29922;padding:10px 16px;margin:8px 0;border-radius:0 6px 6px 0;font-size:13px}
  .heat-box{background:#0f1318;border-left:3px solid #3fb950;padding:10px 16px;margin:8px 0;border-radius:0 6px 6px 0;font-size:13px}
  .learn-box{background:#13111a;border-left:3px solid #d2a8ff;padding:14px 16px;border-radius:0 8px 8px 0;margin:8px 0}
  .coaching{color:#d2a8ff;font-style:italic;font-size:13px}
  .risk-card{background:#0f1318;border:1px solid #1c2333;border-radius:8px;padding:12px 16px;margin:8px 0}
  table{width:100%;border-collapse:collapse;margin:6px 0 10px 0;font-size:13px}
  th{background:#0f1318;color:#7d8590;text-align:left;padding:5px 8px;border-bottom:1px solid #1c2333;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
  td{padding:5px 8px;border-bottom:1px solid #161b22;vertical-align:top}
  tr:hover{background:#0f1318}.tc{white-space:nowrap}
  .heatmap{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin:8px 0}
  .hm-hot2,.hm-hot1,.hm-flat,.hm-cold1,.hm-cold2,.hm-cold3{padding:8px 6px;border-radius:4px;text-align:center;font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace}
  .hm-hot2{background:#0a2e15;color:#56d364}.hm-hot1{background:#0a2610;color:#7ee787}.hm-flat{background:#161b22;color:#7d8590}
  .hm-cold1{background:#1f1315;color:#ffa198}.hm-cold2{background:#2c1519;color:#f85149}.hm-cold3{background:#3d1519;color:#ff7b72}
  .tracker{display:flex;gap:3px;align-items:flex-end;margin:6px 0;height:40px}
  .tracker-bar{flex:1;border-radius:2px 2px 0 0;min-width:16px}
  .score-big{font-family:'JetBrains Mono',monospace;font-size:32px;font-weight:700}
  .divider{border:0;border-top:1px solid #1c2333;margin:20px 0}
  .footer{text-align:center;color:#30363d;font-size:11px;margin-top:24px;font-family:'JetBrains Mono',monospace}
  .pos-block{border-bottom:1px solid #161b22;padding:8px 0}.pos-block:last-child{border-bottom:0}
  .gauge{display:flex;align-items:center;gap:8px;margin:4px 0}
  .gauge-bar{flex:1;height:8px;background:#161b22;border-radius:4px;overflow:hidden}
  .gauge-fill{height:100%;border-radius:4px}
  .gauge-label{font-size:11px;font-family:'JetBrains Mono',monospace;min-width:40px;text-align:right}
  .status-bar{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:#161b22;border-radius:6px;font-size:11px;margin-bottom:8px}
  .pulse{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
  .pulse-live{background:#3fb950;animation:blink 2s infinite}.pulse-stale{background:#d29922}.pulse-off{background:#f85149}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}
  .news-item{padding:8px 10px;border-bottom:1px solid #161b22}
  .news-item a{color:#e6edf3;font-size:13px;line-height:1.5}.news-item a:hover{color:#58a6ff}
  .news-meta{font-size:11px;color:#7d8590;margin-top:3px}.news-src{color:#58a6ff}.news-time{margin-left:6px}.news-item.stale{opacity:0.35}
  .ratio-row{padding:6px 0;border-bottom:1px solid #161b22}
  @media(max-width:480px){body{padding:8px;font-size:13px}.heatmap{grid-template-columns:repeat(3,1fr)}table{font-size:12px}}
</style>
</head>
<body>
<div class="status-bar"><div><span class="pulse pulse-off" id="pl"></span><span id="st">Connecting...</span></div><div id="lu" class="mono">--:--</div></div>
<h1 id="hdr">üì° V9 Trading Dashboard</h1>
<p class="dim" style="font-size:12px;margin-top:-8px" id="sub">Loading...</p>
<div id="loader" style="padding:16px"><div style="background:#161b22;border-radius:8px;padding:16px;margin-bottom:12px"><div style="height:14px;width:60%;background:linear-gradient(90deg,#21262d 25%,#30363d 50%,#21262d 75%);background-size:200%;border-radius:4px;animation:shimmer 1.5s infinite"></div><div style="height:10px;width:40%;background:linear-gradient(90deg,#21262d 25%,#30363d 50%,#21262d 75%);background-size:200%;border-radius:4px;margin-top:8px;animation:shimmer 1.5s infinite .2s"></div></div><div style="background:#161b22;border-radius:8px;padding:16px;margin-bottom:12px"><div style="height:14px;width:80%;background:linear-gradient(90deg,#21262d 25%,#30363d 50%,#21262d 75%);background-size:200%;border-radius:4px;animation:shimmer 1.5s infinite .4s"></div><div style="height:10px;width:55%;background:linear-gradient(90deg,#21262d 25%,#30363d 50%,#21262d 75%);background-size:200%;border-radius:4px;margin-top:8px;animation:shimmer 1.5s infinite .6s"></div></div><style>@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}</style></div>
<div id="sGP"></div>
<div id="sBreadth"></div>
<div id="sSess"></div>
<div id="sGrowth"></div>
<div id="sDefense"></div>
<div id="sStory"></div>
<div id="sInverse"></div>
<div id="sNews"></div>
<hr class="divider">
<div id="sBook"></div>
<div id="sAreteBook"></div>
<div id="sWatching"></div>
<div id="sSetups"></div>
<div id="sPortRisk"></div>
<div id="sRatios"></div>
<hr class="divider">
<div id="sCoach"></div>
<div class="footer" id="foot">THE SYSTEM PROTECTS YOU. FOLLOW IT.<br><small>V9 Dashboard ¬∑ Polling 60s</small></div>
<script>
var EP='https://script.google.com/macros/s/AKfycbyA45O4vPIEOTdOW601PmdkdnOpTDSzu44qaSPq-PDBhElHlzThmyqdvD8MO7IZqmLq/exec';
var _d,_n=0,_e=0;
var SN={SOXX:'Semis',SMH:'Semis',XLK:'Tech',XLY:'Cons Disc',XLF:'Financials',XLI:'Industrials',XLC:'Comm Svcs',IWM:'Small Cap',XLU:'Utilities',XLP:'Staples',XLV:'Healthcare',XLE:'Energy',XLB:'Materials'};
var GPC={A:'g',B:'b',C:'y',D:'r'};
function $(i){return document.getElementById(i)}
function e(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
var _ic={};
function tkLink(tk){return'<a href="https://www.tradingview.com/chart/?symbol='+encodeURIComponent(tk)+'" target="_blank" style="color:#58a6ff;font-size:11px;font-weight:700;text-decoration:none">$'+e(tk)+'</a>';}
function pct(v){var s=String(v||''),n=parseFloat(s.replace('%',''));if(isNaN(n))return'<span class="dim">‚Äî</span>';if(Math.abs(n)<0.5&&s.indexOf('%')<0)n*=100;var c=n>0.01?'g':n<-0.01?'r':'dim';return'<span class="'+c+'">'+(n>0?'+':'')+n.toFixed(2)+'%</span>'}
function pc(v){var n=parseFloat(String(v).replace(/[$,+]/g,''));return n>0?'g':n<0?'r':'dim'}
function tA(ep){if(!ep)return'';var s=Math.floor(Date.now()/1000)-ep;if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';if(s<86400)return Math.floor(s/3600)+'h';return Math.floor(s/86400)+'d'}
function hc(v){if(v>=2)return'hm-hot2';if(v>=.5)return'hm-hot1';if(v>-.5)return'hm-flat';if(v>-1.5)return'hm-cold1';if(v>-2.5)return'hm-cold2';return'hm-cold3'}
function bc(s){var n=parseFloat(s);return n>=9.5?'#00C853':n>=3?'#2196F3':n>=-3?'#FF9800':'#F44336'}
function bh(s){var n=parseFloat(s);return Math.min(100,Math.max(10,(n+10)/20*100))+'%'}
function sL(p){return{PM:'Pre-Market',OPEN:'Morning',CORE:'Core',AH:'After Hours',OFF:'Closed'}[p]||p}
function gS(d,n){return(d.market&&d.market[n])||[]}
function fS(a,s){for(var i=0;i<a.length;i++)if(a[i].sym===s)return a[i];return null}
function bCls(s){var n=parseFloat(s);return n>=9.5?'g':n>=3?'y':n>=-3?'dim':'r'}

function poll(){
  fetch(EP+'?mode=dashboard&t='+Date.now()).then(function(r){if(!r.ok)throw new Error(r.status);return r.json()}).then(function(d){
    _d=d;_n++;_e=0;var ld=$('loader');if(ld)ld.remove();R(d);$('pl').className='pulse pulse-live';$('st').textContent='Live ¬∑ #'+_n;
    $('lu').textContent=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:'America/Phoenix'});
  }).catch(function(err){_e++;var ld=$('loader');if(ld)ld.innerHTML='<div style="color:#f85149;padding:16px;font-size:13px">‚ùå '+err.message+'<br><br><span class="dim">Check: did you deploy a NEW version? The endpoint URL may have changed.<br>Current EP: '+EP.substring(0,60)+'...</span></div>';$('pl').className='pulse pulse-'+(_e>3?'off':'stale');$('st').textContent='Error'+(_e>1?' (√ó'+_e+')':'');});
}

function R(d){rHdr(d);rGP(d);rBreadth(d);rSess(d);rSectors(d);rStory(d);rInv(d);rNews(d);rBook(d);rAreteBook(d);rWatching(d);rSetups(d);rRisk(d);rRatios(d);rCoach(d);rFoot(d);}

function rHdr(d){var now=new Date(),dn='Sun Mon Tue Wed Thu Fri Sat'.split(' '),mn='Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec'.split(' ');
$('hdr').innerHTML='üì° V9 Dashboard ‚Äî '+dn[now.getDay()]+' '+mn[now.getMonth()]+' '+now.getDate()+' ¬∑ '+sL(d.phase);
$('sub').innerHTML='GP-'+(d.gpLetter||'C')+' ¬∑ Score: '+(d.breadthScore||'‚Äî')+' ¬∑ '+(d.enabled?'<span class="g">Scanner ON</span>':'<span class="r">Scanner OFF</span>');}

// ‚ïê‚ïê‚ïê GAMEPLAN (with tracker) ‚ïê‚ïê‚ïê
function rGP(d){
  var gp=d.gpLetter||'C',sc=d.breadthScore||'‚Äî',sp=d.sectorPts||'‚Äî',cl=GPC[gp]||'dim';
  var lab={A:'Hunt Mode ¬∑ $15-20K',B:'Sniper Mode ¬∑ $8-12K',C:'Bench Mode ¬∑ No Trades',D:'Short Mode ¬∑ Inverse ETFs'};
  var h='<h2>Gameplan</h2><div class="gp-box"><span class="tag tag-gp tag-gp-'+gp.toLowerCase()+'">GP-'+gp+' ¬∑ '+sc+' pts ¬∑ '+sL(d.phase)+'</span>';
  h+='<p style="margin-top:8px" class="white bold">'+e(lab[gp])+'</p>';
  var bn=gS(d,'BENCHMARKS'),spy=fS(bn,'SPY'),qqq=fS(bn,'QQQ'),bd=gS(d,'BREADTH DETAIL').concat(gS(d,'INTERNALS')),vix=fS(bd,'$VIX');
  h+='<p class="dim" style="font-size:13px">';if(spy)h+='SPY '+e(spy.val)+' ('+pct(spy.chg)+') ¬∑ ';if(qqq)h+='QQQ '+e(qqq.val)+' ('+pct(qqq.chg)+') ¬∑ ';if(vix)h+='VIX '+e(vix.val);h+='</p>';
  var hist=d.history||[];
  if(hist.length>0){h+='<table style="margin-top:8px;font-size:12px"><tr><th>Time</th><th>GP</th><th>Score</th></tr>';var r=hist.slice(-8);for(var i=0;i<r.length;i++){var s=parseFloat(r[i].score)||0,c=bCls(s),last=i===r.length-1;h+='<tr'+(last?' style="font-weight:700"':'')+'><td class="dim">'+e(r[i].time)+'</td><td class="'+c+' bold">'+e(r[i].gp)+'</td><td class="'+c+'">'+s.toFixed(1)+'</td></tr>';}h+='</table>';}
  h+='</div>';$('sGP').innerHTML=h;
}

// ‚ïê‚ïê‚ïê BREADTH (tracker + detail combined) ‚ïê‚ïê‚ïê
function rBreadth(d){
  var score=parseFloat(d.breadthScore)||0,hist=d.history||[],cls=bCls(score);
  var trend=score>=9.5?'‚ñ≤ Strong':score>=3?'‚ñ≤ Positive':score>=-3?'‚óÜ Neutral':'‚ñº Negative';
  var h='<h2>Breadth</h2><div class="info-box"><p><span class="score-big '+cls+'">'+score.toFixed(1)+'</span> <span class="dim" style="font-size:14px">¬∑ <span class="'+cls+' bold">'+trend+'</span></span></p>';
  if(hist.length>1){var r=hist.slice(-10);h+='<div class="tracker" style="margin-top:10px">';for(var i=0;i<r.length;i++){var s=parseFloat(r[i].score)||0;h+='<div class="tracker-bar" style="height:'+bh(s)+';background:'+bc(s)+'"></div>';}h+='</div><div style="display:flex;justify-content:space-between;font-size:9px;color:#484f58">';for(var i=0;i<r.length;i++){var t=r[i].time||'',p=t.split(' ');h+='<span>'+e(p[p.length-1]||t)+'</span>';}h+='</div>';}
  // Detail indicators
  var bd=gS(d,'BREADTH DETAIL').concat(gS(d,'INTERNALS'));
  var items=bd.filter(function(x){return x.sym!=='$VIX'&&x.sym!=='$DXY'});
  if(items.length>0){
    h+='<table style="margin-top:12px;font-size:12px"><tr><th style="min-width:70px">Indicator</th><th style="min-width:55px;text-align:right">Value</th><th>Signal</th></tr>';
    for(var i=0;i<items.length;i++){var desc=items[i].desc||'',ins=desc.indexOf('‚Äî')>=0?desc.split('‚Äî').slice(1).join('‚Äî').trim():desc;
      var sym=String(items[i].sym||'').replace(/\s*\(scaled\)/gi,''),rawV=String(items[i].val||'');
      var val=parseFloat(rawV.replace(/[,N\/A]/g,'')),vC='dim';
      var dv=rawV;if(!isNaN(val)){if(sym==='$TRIN'||sym==='$TRINQ')dv=val.toFixed(2);else if(Math.abs(val)>100)dv=String(Math.round(val));else dv=val.toFixed(2);}
      if(sym==='$ADD'||sym==='$ADQD')vC=val>1000?'g':val>0?'y':val>-1000?'y':'r';
      else if(sym==='$TICK'||sym==='$TICKQ')vC=val>500?'g':val>0?'y':val>-500?'y':'r';
      else if(sym.indexOf('VOLD')>=0||sym.indexOf('VOLQD')>=0)vC=val>0?'g':'r';
      else if(sym.indexOf('TRIN')>=0)vC=val<1?'g':val<1.5?'y':'r';
      h+='<tr><td class="white bold">'+e(sym)+'</td><td class="'+vC+' bold mono" style="text-align:right">'+e(dv)+'</td><td class="dim" style="font-size:11px">'+e(ins)+'</td></tr>';
    }h+='</table>';}
  h+='</div>';$('sBreadth').innerHTML=h;
}

// ‚ïê‚ïê‚ïê SESSION STATS (benchmarks + commodities + Opus analysis) ‚ïê‚ïê‚ïê
function rSess(d){
  var bn=gS(d,'BENCHMARKS'),fut=gS(d,'FUTURES'),comm=gS(d,'COMMODITIES');
  if(!bn.length&&!fut.length){$('sSess').innerHTML='';return}
  // Get Opus session analysis
  var nar=d.dashboardNarrative||'',sec=parseN(nar),sessAn=gN(sec,['SESSION ANALYSIS','SESSION','MARKET ANALYSIS','ASSET ANALYSIS','KEY LEVELS','STATS']);
  var anMap={};if(sessAn){var lines=sessAn.replace(/\|/g,'\n').split('\n');for(var i=0;i<lines.length;i++){var m=lines[i].trim().match(/^\**([A-Z$\/0-9]+)\**:?\s*(.+)/);if(m){var tk=m[1].replace(/\*/g,'').trim();anMap[tk]=m[2].trim();}}};
  var h='<h2>Session Stats</h2><div class="info-box"><table><tr><th>Ticker</th><th>Last</th><th>Chg%</th><th>Analysis</th></tr>';
  var keys=['SPY','QQQ','DIA','IWM'];for(var k=0;k<keys.length;k++){var it=fS(bn,keys[k]);if(it){var an=anMap[it.sym]||'';h+='<tr><td class="white bold tc">'+e(it.sym)+'</td><td class="mono">'+e(it.val)+'</td><td>'+pct(it.chg)+'</td><td class="dim" style="font-size:12px">'+e(an)+'</td></tr>';}}
  var bd=gS(d,'BREADTH DETAIL').concat(gS(d,'INTERNALS')),vix=fS(bd,'$VIX'),dxy=fS(bd,'$DXY');
  if(vix){var va=anMap['VIX']||anMap['$VIX']||'';h+='<tr><td class="y bold tc">$VIX</td><td class="mono">'+e(vix.val)+'</td><td>'+pct(vix.chg)+'</td><td class="dim" style="font-size:12px">'+e(va)+'</td></tr>';}
  if(dxy){var da=anMap['DXY']||anMap['$DXY']||'';h+='<tr><td class="dim tc">$DXY</td><td class="mono">'+e(dxy.val)+'</td><td>'+pct(dxy.chg)+'</td><td class="dim" style="font-size:12px">'+e(da)+'</td></tr>';}
  for(var c=0;c<comm.length;c++){var ca=anMap[comm[c].sym]||'';h+='<tr><td class="dim tc">'+e(comm[c].sym)+'</td><td class="mono">'+e(comm[c].val)+'</td><td>'+pct(comm[c].chg)+'</td><td class="dim" style="font-size:12px">'+e(ca)+'</td></tr>';}
  if(fut.length){h+='<tr><td colspan="4" style="font-size:11px;color:#7d8590;padding-top:6px;border:none">FUTURES</td></tr>';for(var f=0;f<fut.length;f++)h+='<tr><td class="dim tc">'+e(fut[f].sym)+'</td><td class="mono">'+e(fut[f].val)+'</td><td>'+pct(fut[f].chg)+'</td><td></td></tr>';}
  h+='</table></div>';$('sSess').innerHTML=h;
}

// ‚ïê‚ïê‚ïê SECTORS ‚ïê‚ïê‚ïê
function rSectors(d){
  var hm=d.sectorHeatmap||[],gr=hm.filter(function(x){return x.type==='G'}).sort(function(a,b){return b.chg-a.chg}),df=hm.filter(function(x){return x.type==='D'}).sort(function(a,b){return b.chg-a.chg});
  var gg=gr.filter(function(x){return x.chg>0.05}).length,dg=df.filter(function(x){return x.chg>0.05}).length;
  var h='<h2>Sectors ‚Äî Growth ('+gg+'/'+gr.length+')</h2><div class="heatmap">';
  for(var i=0;i<gr.length;i++){var nm=SN[gr[i].sym]||'';h+='<div class="'+hc(gr[i].chg)+'">'+e(gr[i].sym)+'<br>'+(gr[i].chg>0?'+':'')+gr[i].chg.toFixed(2)+'%'+(nm?'<br><span style="font-size:9px;opacity:.7">'+e(nm)+'</span>':'')+'</div>';}
  h+='</div>';$('sGrowth').innerHTML=h;
  var hd='<h2>Sectors ‚Äî Defensive ('+dg+'/'+df.length+')</h2><div class="heatmap" style="grid-template-columns:repeat('+Math.min(df.length,5)+',1fr)">';
  for(var i=0;i<df.length;i++){var nm=SN[df[i].sym]||'';hd+='<div class="'+hc(df[i].chg)+'">'+e(df[i].sym)+'<br>'+(df[i].chg>0?'+':'')+df[i].chg.toFixed(2)+'%'+(nm?'<br><span style="font-size:9px;opacity:.7">'+e(nm)+'</span>':'')+'</div>';}
  hd+='</div>';$('sDefense').innerHTML=hd;
}

// ‚ïê‚ïê‚ïê THE STORY + GAMEPLAN STATUS (colored) ‚ïê‚ïê‚ïê
function rStory(d){
  var nar=d.dashboardNarrative||'';if(!nar){$('sStory').innerHTML='<h2>The Story</h2><div class="info-box"><p class="dim">No Opus narrative yet. Run üì° Dashboard Now.</p></div>';return}
  var sec=parseN(nar),ts=d.dashboardTimestamp||'',gp=d.gpLetter||'C',cl=GPC[gp]||'dim';
  var h='<h2>The Story</h2><p class="dim" style="font-size:11px">Opus ¬∑ '+e(ts)+' ¬∑ '+e(d.dashboardSession||'')+'</p>';
  var story=gN(sec,['THE STORY','STORY','MARKET STORY']);if(story)h+='<div class="story-box">'+fmt(story)+'</div>';
  var gps=gN(sec,['GAMEPLAN STATUS','GAMEPLAN','GP STATUS']);
  if(gps){h+='<h3>Gameplan Status</h3><div class="info-box" style="border-color:'+bc(d.breadthScore||0)+';font-size:13px;line-height:1.7"><span class="'+cl+' bold" style="font-size:14px">GP-'+gp+'</span> '+fmt(gps)+'</div>';}
  h+='</div>';$('sStory').innerHTML=h;
}

// ‚ïê‚ïê‚ïê INVERSE ETFs ‚ïê‚ïê‚ïê
function rInv(d){if((d.gpLetter||'C')!=='D'){$('sInverse').innerHTML='';return}var inv=gS(d,'INVERSE ETFs (GP-D)');if(!inv.length){$('sInverse').innerHTML='';return}var h='<h2 style="color:#f85149">Inverse ETFs ‚Äî GP-D</h2><div class="info-box"><table><tr><th>ETF</th><th>Last</th><th>Chg%</th><th>Tracks</th></tr>';for(var i=0;i<inv.length;i++)h+='<tr><td class="r bold tc">'+e(inv[i].sym)+'</td><td>'+e(inv[i].val)+'</td><td>'+pct(inv[i].chg)+'</td><td class="dim">'+e(inv[i].desc)+'</td></tr>';h+='</table></div>';$('sInverse').innerHTML=h;}

// ‚ïê‚ïê‚ïê NEWS ‚ïê‚ïê‚ïê
var NT=[
{l:"Tariffs",rx:/tariff|trade war|trade deal|import dut|export ban/i,bg:"#F44336",fg:"#fff"},
{l:"Fed",rx:/the fed |federal reserve|rate cut|rate hike|fomc|powell|hawkish|dovish/i,bg:"#2196F3",fg:"#fff"},
{l:"Inflation",rx:/cpi |ppi |pce |inflation|consumer price/i,bg:"#FF9800",fg:"#000"},
{l:"Jobs",rx:/nonfarm|payroll|unemployment|jobless claim|jobs report/i,bg:"#9C27B0",fg:"#fff"},
{l:"Oil",rx:/oil price|crude oil|opec|brent crude|wti crude/i,bg:"#795548",fg:"#fff"},
{l:"China",rx:/china|chinese|beijing|xi jinping/i,bg:"#F44336",fg:"#fff"},
{l:"Semis",rx:/semiconductor|chip maker|chipmaker|nvidia|nvda|amd |tsmc|asml|chip stock/i,bg:"#4caf50",fg:"#fff"},
{l:"AI",rx:/artificial intelligence|ai model|ai launch|ai invest|ai chip|openai|chatgpt|deepseek/i,bg:"#E040FB",fg:"#fff"},
{l:"Earnings",rx:/earnings|revenue miss|revenue beat|quarterly result|beats estimate|misses estimate/i,bg:"#FFD600",fg:"#000"},
{l:"Crypto",rx:/bitcoin|btc |crypto|ethereum/i,bg:"#FF9800",fg:"#000"},
{l:"Bonds",rx:/treasury|bond yield|10-year|yield curve/i,bg:"#607D8B",fg:"#fff"},
{l:"Gold",rx:/gold price|gold surge|gold drop|precious metal/i,bg:"#FFD600",fg:"#000"},
{l:"Geopolitical",rx:/military|missile|invasion|geopolit|conflict|iran|russia|ukraine|israel/i,bg:"#F44336",fg:"#fff"},
{l:"Analyst",rx:/upgrade|downgrade|price target|overweight|underweight|outperform/i,bg:"#42A5F5",fg:"#fff"},
{l:"M&A",rx:/merger|acquisition|acquir|buyout|takeover/i,bg:"#CE93D8",fg:"#000"},
{l:"Guidance",rx:/raised guidance|lowered guidance|cuts forecast|raises forecast/i,bg:"#FFF176",fg:"#000"},
{l:"Energy",rx:/natural gas|solar|nuclear|lng |clean energy/i,bg:"#66BB6A",fg:"#000"},
{l:"Defense",rx:/pentagon|defense contract|lockheed|raytheon|military spend/i,bg:"#5C6BC0",fg:"#fff"}
];
var CM={"apple":"AAPL","microsoft":"MSFT","google":"GOOG","alphabet":"GOOG","amazon":"AMZN","meta":"META","nvidia":"NVDA","tesla":"TSLA","amd":"AMD","intel":"INTC","broadcom":"AVGO","qualcomm":"QCOM","tsmc":"TSM","asml":"ASML","micron":"MU","palantir":"PLTR","salesforce":"CRM","adobe":"ADBE","coinbase":"COIN","jpmorgan":"JPM","goldman":"GS","disney":"DIS","boeing":"BA","exxon":"XOM","chevron":"CVX","walmart":"WMT","uber":"UBER","crowdstrike":"CRWD","snowflake":"SNOW","arm holdings":"ARM","super micro":"SMCI","eli lilly":"LLY","novo nordisk":"NVO","berkshire":"BRK.B"};
var SKIP={"THE":1,"AND":1,"FOR":1,"ARE":1,"BUT":1,"NOT":1,"ALL":1,"CAN":1,"HAS":1,"WAS":1,"ONE":1,"NEW":1,"NOW":1,"MAY":1,"SAY":1,"TWO":1,"HOW":1,"ITS":1,"USE":1,"CEO":1,"IPO":1,"GDP":1,"CPI":1,"PPI":1,"PCE":1,"FED":1,"SEC":1,"USA":1,"NYSE":1,"ETF":1,"DOJ":1,"FTC":1,"NATO":1,"OPEC":1,"IMF":1,"WHO":1,"FBI":1};
function nTags(hl,rel){var tags=[],tks=[],seen={};for(var t=0;t<NT.length;t++)if(NT[t].rx.test(hl))tags.push(NT[t]);if(rel){var rs=rel.split(',');for(var r=0;r<rs.length;r++){var tk=rs[r].trim().toUpperCase();if(tk&&tk.length<=5&&!seen[tk]){seen[tk]=1;tks.push(tk)}}}var dm=hl.match(/\$([A-Z]{1,5})/g);if(dm)for(var d=0;d<dm.length;d++){var tk=dm[d].replace('$','');if(!seen[tk]){seen[tk]=1;tks.push(tk)}}var ws=hl.split(/[^A-Za-z]+/);for(var w=0;w<ws.length;w++){var wd=ws[w];if(wd.length>=2&&wd.length<=5&&wd===wd.toUpperCase()&&/^[A-Z]+$/.test(wd)&&!SKIP[wd]&&!seen[wd]){seen[wd]=1;tks.push(wd)}}var lo=hl.toLowerCase(),ck=Object.keys(CM);for(var c=0;c<ck.length;c++)if(lo.indexOf(ck[c])>=0){var tk=CM[ck[c]];if(!seen[tk]){seen[tk]=1;tks.push(tk)}}return{tags:tags,tickers:tks};}
function rNews(d){var news=d.news||[];if(!news.length){$('sNews').innerHTML='';return}var h='<h2 style="color:#d29922">Market News ('+news.length+')</h2><div class="info-box" style="padding:0">';for(var i=0;i<Math.min(news.length,25);i++){var n=news[i],age=tA(n.time),stale=(Date.now()/1000-(n.time||0))>7200,src=n.source||n.feed||'',ft=n.feed||'';var nt=nTags(n.headline||'',n.related||'');h+='<div class="news-item'+(stale?' stale':'')+'">';h+='<a href="'+e(n.url)+'" target="_blank">'+e(n.headline)+'</a>';if(nt.tags.length||nt.tickers.length){h+='<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:3px">';for(var t=0;t<nt.tags.length;t++)h+='<span style="font-size:10px;font-weight:700;padding:1px 6px;border-radius:8px;background:'+nt.tags[t].bg+';color:'+nt.tags[t].fg+'">'+e(nt.tags[t].l)+'</span>';for(var k=0;k<Math.min(nt.tickers.length,5);k++)h+='<span style="font-size:10px;font-weight:700;padding:1px 6px;border-radius:8px;background:#1a1a2e;color:#4caf50;border:1px solid #4caf50">$'+e(nt.tickers[k])+'</span>';h+='</div>';}h+='<div class="news-meta"><span class="news-src">'+e(src)+'</span>'+(ft&&ft!==src?' ['+e(ft)+']':'')+'<span class="news-time">'+age+'</span></div></div>';}h+='</div>';$('sNews').innerHTML=h;}

// ‚ïê‚ïê‚ïê YOUR BOOK (positions + Opus alerts merged) ‚ïê‚ïê‚ïê
// Helper to render a position card
function posCard(p,alert){
  var h='<div class="pos-block"><div style="display:flex;justify-content:space-between;align-items:center">';
  h+='<span>'+tkLink(p.ticker).replace('font-size:11px','font-size:15px');
  if(p.accountType)h+=' <span class="tag tag-acct">'+e(p.accountType)+'</span>';
  if(p.tag)h+=' <span class="tag" style="background:#13111a;color:#d2a8ff;border:1px solid #2d1f4e">'+e(p.tag)+'</span>';
  h+='</span><span class="'+pc(p.totalPL)+' bold mono" style="font-size:14px">'+e(p.totalPL)+'</span></div>';
  h+='<p style="font-size:12px;color:#7d8590;margin:2px 0">'+e(p.side)+' '+e(p.shares)+'sh @ $'+e(p.avgCost)+' ‚Üí $'+e(p.last)+'</p>';
  h+='<p style="font-size:12px;margin:0">Day: <span class="'+pc(p.dayPL)+' bold">'+e(p.dayPL)+' ('+e(p.dayPLPct)+')</span> ¬∑ Total: <span class="'+pc(p.totalPL)+' bold">'+e(p.totalPLPct)+'</span></p>';
  if(alert){var acl=String(alert.action||'').match(/trim|exit|review|broken|stop/i)?'r':String(alert.action||'').match(/hold|monitor/i)?'y':'b';
    h+='<p style="font-size:12px;margin-top:4px"><span class="'+acl+' bold">‚Üí '+e(alert.action)+'</span></p>';}
  h+='</div>';return h;
}
function getAlertMap(d){
  var nar=d.dashboardNarrative||'',sec=parseN(nar),pa=gN(sec,['POSITION ALERTS','POSITIONS','ALERTS','YOUR BOOK','BOOK','ACTIVE POSITIONS','PORTFOLIO ALERTS']);
  var am={};if(pa){var lines=pa.split('\n');for(var i=0;i<lines.length;i++){var parts=lines[i].split('|').map(function(x){return x.trim()}).filter(function(x){return x});if(parts.length>=2){var tk=parts[0].replace(/\*\*/g,'').trim();am[tk]={status:parts.length>=2?parts[1]:'',action:parts.length>=3?parts[2]:(parts.length>=2?parts[1]:'')};}}}return am;
}
// ‚ïê‚ïê‚ïê YOUR BOOK (live + paper positions with Opus alerts) ‚ïê‚ïê‚ïê
function rBook(d){
  var pos=d.positions||[],paper=d.paperPositions||[];
  var alertMap=getAlertMap(d);
  var h='<h2><span class="tag tag-live">YOUR BOOK</span> Positions ('+(pos.length+paper.length)+')</h2>';
  if(!pos.length&&!paper.length){h+='<div class="info-box"><p class="dim">No positions loaded.</p></div>';$('sBook').innerHTML=h;return}
  // Live positions
  if(pos.length){h+='<div class="info-box">';for(var i=0;i<pos.length;i++)h+=posCard(pos[i],alertMap[pos[i].ticker]||null);h+='</div>';}
  // Paper trades
  if(paper.length){h+='<h3 style="margin-top:12px">üìã Paper Trades ('+paper.length+')</h3><div class="info-box" style="border-color:#30363d">';for(var i=0;i<paper.length;i++)h+=posCard(paper[i],null);h+='</div>';}
  else{h+='<h3 style="margin-top:12px">üìã Paper Trades</h3><div class="info-box" style="border-color:#30363d"><p class="dim" style="font-size:12px">No paper trades active.</p></div>';}
  $('sBook').innerHTML=h;
}
// ‚ïê‚ïê‚ïê ARETE BOOK (carries/swings + day trade carry-overs ‚Äî separate from your book) ‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê ARETE BOOK (from Arete Trades tab ‚Äî reference only) ‚ïê‚ïê‚ïê
function rAreteBook(d){
  var sw=d.areteSwing||[],carry=d.areteCarry||[];
  if(!sw.length&&!carry.length){$('sAreteBook').innerHTML='';return}
  var h='<h2 style="color:#d29922"><span class="tag" style="background:#1f1a0f;color:#d29922;border:1px solid #9e6a03">ARETE</span> Book</h2>';
  h+='<p class="dim" style="font-size:11px;margin-bottom:6px">Arete Discord positions ‚Äî reference only, not your trades.</p>';
  // Swing Trades
  if(sw.length){h+='<h3 style="color:#d29922">Swing Trades ('+sw.length+')</h3><div class="info-box" style="border-color:#9e6a03"><table><tr><th>Ticker</th><th>Side</th><th>Entry</th><th>Date</th><th>Note</th></tr>';
    for(var i=0;i<sw.length;i++){var s=sw[i];h+='<tr><td class="tc">'+tkLink(s.ticker)+(s.flag?' <span class="g bold" style="font-size:10px">'+e(s.flag)+'</span>':'')+'</td><td class="dim">'+e(s.side)+'</td><td class="mono">'+e(s.entry)+'</td><td class="dim">'+e(s.date)+'</td><td class="dim" style="font-size:11px;max-width:120px">'+e(s.note)+'</td></tr>';}
    h+='</table></div>';}
  // DT Carry-Overs
  if(carry.length){h+='<h3 style="color:#d29922">DT Carry-Overs ('+carry.length+')</h3><div class="info-box" style="border-color:#9e6a03"><table><tr><th>Ticker</th><th>Side</th><th>Entry</th><th>Date</th><th>Note</th></tr>';
    for(var i=0;i<carry.length;i++){var c=carry[i];h+='<tr><td class="tc">'+tkLink(c.ticker)+(c.flag?' <span class="g bold" style="font-size:10px">'+e(c.flag)+'</span>':'')+'</td><td class="dim">'+e(c.side)+'</td><td class="mono">'+e(c.entry)+'</td><td class="dim">'+e(c.date)+'</td><td class="dim" style="font-size:11px;max-width:120px">'+e(c.note)+'</td></tr>';}
    h+='</table></div>';}
  $('sAreteBook').innerHTML=h;
}
// ‚ïê‚ïê‚ïê WATCHING (Config tab: my watching + arete watching with tags) ‚ïê‚ïê‚ïê
function rWatching(d){
  var mw=d.myWatching||[],aw=d.areteWatching||[];
  if(!mw.length&&!aw.length){$('sWatching').innerHTML='';return}
  var h='<h2>üëÄ Watching</h2><div class="info-box">';
  if(mw.length){h+='<h3>My Watching ('+mw.length+')</h3>';
    for(var i=0;i<mw.length;i++){var w=mw[i];
      h+=tkLink(w.ticker)+' ';
      if(w.tag)h+='<span class="tag" style="background:#13111a;color:#d2a8ff;border:1px solid #2d1f4e;font-size:9px;margin-right:6px">'+e(w.tag)+'</span>';}
    h+='<br style="margin-bottom:8px">';}
  if(aw.length){h+='<h3 style="color:#d29922">Arete Watching ('+aw.length+')</h3>';
    for(var i=0;i<aw.length;i++)h+=tkLink(aw[i])+' ';}
  h+='</div>';$('sWatching').innerHTML=h;
}
function rSetups(d){
  var w=d.watchlistTop||[];
  var nar=d.dashboardNarrative||'',sec=parseN(nar),ts=gN(sec,['TOP SETUPS','SETUPS','WATCHLIST','SETUPS & WATCHLIST','ACTIONABLE','TRADE IDEAS','OPPORTUNITIES']);
  if(!w.length&&!ts){$('sSetups').innerHTML='';return}
  var h='<h2>Setups & Watchlist</h2>';
  // Opus narrative first
  if(ts)h+='<div class="alert-box">'+fmt(ts)+'</div>';
  // Confluence table
  if(w.length){h+='<div class="info-box"><table><tr><th>Ticker</th><th>Last</th><th>Conf</th><th>Qual</th><th>Setup</th><th style="font-size:10px">Section</th></tr>';
    for(var i=0;i<Math.min(w.length,15);i++){var it=w[i],cc=it.confluence>=28?'g':it.confluence>=24?'y':'dim';
      h+='<tr><td class="tc">'+tkLink(it.ticker)+'</td><td>'+e(it.last)+'</td><td class="'+cc+' bold mono">'+it.confluence.toFixed(1)+'</td><td class="dim">'+e(it.quality)+'</td><td class="dim">'+e(it.setup)+'</td><td class="dim" style="font-size:11px">'+e(it.section)+'</td></tr>';}
    h+='</table></div>';}
  $('sSetups').innerHTML=h;
}

// ‚ïê‚ïê‚ïê PORTFOLIO RISK (exposure + correlation + Opus recommendations merged) ‚ïê‚ïê‚ïê
function rRisk(d){
  var pos=d.positions||[];
  var nar=d.dashboardNarrative||'',sec=parseN(nar);
  var prNar=gN(sec,['PORTFOLIO RISK','CORRELATION CHECK','CORRELATION','RISK','RISK MANAGEMENT','EXPOSURE','CONCENTRATION']);
  if(!pos.length&&!prNar){$('sPortRisk').innerHTML='';return}
  var h='<h2>Portfolio Risk</h2>';
  // Opus narrative
  if(prNar)h+='<div class="alert-box" style="border-color:#f85149">'+fmt(prNar)+'</div>';
  // Live numbers
  if(pos.length){
    var tMV=0,tDay=0,tUn=0,tags={},longs=0,shorts=0;
    for(var i=0;i<pos.length;i++){var p=pos[i];var mv=parseFloat(String(p.mktValue||'0').replace(/[$,+]/g,''))||0;var dp=parseFloat(String(p.dayPL||'0').replace(/[$,+]/g,''))||0;var tp=parseFloat(String(p.totalPL||'0').replace(/[$,+]/g,''))||0;tMV+=Math.abs(mv);tDay+=dp;tUn+=tp;if(p.side==='Long')longs++;else shorts++;var t=p.tag||p.accountType||'Untagged';if(!tags[t])tags[t]={count:0,tickers:[]};tags[t].count++;tags[t].tickers.push(p.ticker);}
    h+='<div class="risk-card">';
    h+='<p><span class="white bold">Positions:</span> '+pos.length+' ('+longs+'L/'+shorts+'S) ¬∑ <span class="bold">Limit: 5</span></p>';
    h+='<p><span class="white bold">Exposure:</span> $'+tMV.toLocaleString('en-US',{maximumFractionDigits:0})+' <span class="dim">/ $60K limit</span></p>';
    h+='<p><span class="white bold">Day P&L:</span> <span class="'+pc(tDay)+' bold">'+(tDay>=0?'+$':'-$')+Math.abs(tDay).toFixed(2)+'</span> ¬∑ <span class="white bold">Unrealized:</span> <span class="'+pc(tUn)+' bold">'+(tUn>=0?'+$':'-$')+Math.abs(tUn).toFixed(2)+'</span></p>';
    var tk=Object.keys(tags);if(tk.length){h+='<h3 style="margin-top:8px">Concentration</h3>';for(var i=0;i<tk.length;i++){var pB=Math.round(tags[tk[i]].count/pos.length*100),wc=pB>50?'#f85149':pB>30?'#d29922':'#3fb950';h+='<div class="gauge"><span class="dim" style="min-width:70px;font-size:12px">'+e(tk[i])+'</span><div class="gauge-bar"><div class="gauge-fill" style="width:'+pB+'%;background:'+wc+'"></div></div><span class="gauge-label" style="color:'+wc+'">'+pB+'% ('+tags[tk[i]].tickers.join(',')+')</span></div>';}}
    if(pos.length>=5)h+='<div class="warn-box" style="margin-top:8px"><span class="r bold">‚ö† At 5-position limit.</span></div>';
    h+='</div>';}
  $('sPortRisk').innerHTML=h;
}

// ‚ïê‚ïê‚ïê INTERMARKET RATIOS (with Opus read) ‚ïê‚ïê‚ïê
// Static intermarket reference: what each ratio measures + affected tickers
var IM_REF={
'HYG/TLT':{what:'Credit risk appetite',up:'risk-on, junk bonds bid',dn:'flight to safety, credit stress',tickers:['HYG','TLT','JNK']},
'GLD/SPY':{what:'Gold vs equities',up:'fear/inflation hedge',dn:'risk-on, equities preferred',tickers:['GLD','GDX','NEM']},
'QQQ/SPY':{what:'Tech vs broad market',up:'growth leading',dn:'rotation out of tech',tickers:['QQQ','XLK','AAPL','MSFT']},
'VUG/VTV':{what:'Growth vs value',up:'growth winning',dn:'value rotation',tickers:['VUG','VTV','IWF','IWD']},
'IWM/SPY':{what:'Small cap vs large',up:'broad risk-on',dn:'flight to quality',tickers:['IWM','TNA','TZA']},
'XLK/XLU':{what:'Tech vs utilities',up:'risk-on offensive',dn:'defensive rotation',tickers:['XLK','XLU','NEE']},
'TLT/SHY':{what:'Long vs short bonds',up:'rate cut bets',dn:'higher-for-longer',tickers:['TLT','SHY','TBT']},
'XLE/SPY':{what:'Energy vs broad',up:'inflation/commodity bid',dn:'deflation signal',tickers:['XLE','XOM','CVX','USO']},
'XLF/SPY':{what:'Financials vs broad',up:'yield curve steepening',dn:'banking stress',tickers:['XLF','JPM','GS','BAC']},
'SMH/QQQ':{what:'Semis vs Nasdaq',up:'semis leading tech',dn:'semis lagging',tickers:['SMH','NVDA','AMD','MU','AVGO']}
};
function rRatios(d){
  var r=gS(d,'INTERMARKET RATIOS');if(!r.length){$('sRatios').innerHTML='';return}
  var nar=d.dashboardNarrative||'',sec=parseN(nar),imRead=gN(sec,['INTERMARKET READ','INTERMARKET','RATIOS','CROSS-MARKET','MACRO']);
  var h='<h2>Intermarket</h2>';
  if(imRead)h+='<div class="story-box" style="border-color:#d29922">'+fmt(imRead)+'</div>';
  h+='<div class="info-box">';
  for(var i=0;i<r.length;i++){var cn=parseFloat(String(r[i].chg).replace('%',''));var desc=r[i].desc||'',sig='',ref=IM_REF[r[i].sym]||null;
    if(ref){sig=cn>0.01?ref.up:cn<-0.01?ref.dn:'flat';}
    else if(desc.indexOf('‚Äî')>=0){var rest=desc.split('‚Äî').slice(1).join('‚Äî').trim();if(rest.indexOf('rising')>=0&&rest.indexOf('falling')>=0){if(cn>0.01)sig=rest.split('rising')[1].split(',')[0].replace(/[=]/g,'').trim();else if(cn<-0.01)sig=rest.split('falling')[1].split(',')[0].replace(/[=]/g,'').trim();else sig='flat';}else sig=rest;}else sig=desc;
    var sc=cn>0.01?'g':cn<-0.01?'r':'dim';
    h+='<div class="ratio-row"><div style="display:flex;justify-content:space-between;align-items:baseline">';
    h+='<span class="white bold">'+e(r[i].sym)+'</span><span>'+pct(r[i].chg)+' <span class="'+sc+' bold" style="font-size:12px">'+e(sig)+'</span></span></div>';
    if(ref){h+='<div style="font-size:11px;margin-top:2px"><span class="dim">'+e(ref.what)+'</span>';
      h+=' <span style="color:#484f58">¬∑</span> ';
      for(var t=0;t<Math.min(ref.tickers.length,4);t++)h+=tkLink(ref.tickers[t])+' ';
      h+='</div>';}
    h+='</div>';}
  h+='</div>';$('sRatios').innerHTML=h;
}
// ‚ïê‚ïê‚ïê COACHING ‚ïê‚ïê‚ïê
function rCoach(d){
  var nar=d.dashboardNarrative||'';if(!nar){$('sCoach').innerHTML='';return}
  var sec=parseN(nar),c=gN(sec,['BOTTOM LINE','COACHING','COACH','BEHAVIORAL','DISCIPLINE','ACCOUNTABILITY']),edu=gN(sec,['DAILY EDGE','DAILY EDUCATION','EDUCATION','LEARN','CONCEPT','EDGE','LESSON']);
  var h='';
  if(c)h+='<h2>üß≠ Bottom Line</h2><div class="warn-box" style="border-color:#d29922"><p style="font-size:13px;line-height:1.7">'+fmt(c)+'</p></div>';
  if(edu)h+='<h2>üìö Daily Edge</h2><div class="learn-box"><p style="font-size:13px;line-height:1.7">'+fmt(edu)+'</p></div>';
  $('sCoach').innerHTML=h;
}

function rFoot(d){
  // Show any unmatched Opus sections for debugging
  var nar=d.dashboardNarrative||'';
  if(nar){var sec=parseN(nar);var matched=['THE STORY','STORY','GAMEPLAN STATUS','GAMEPLAN','GP STATUS','SESSION ANALYSIS','SESSION','POSITION ALERTS','POSITIONS','PORTFOLIO RISK','CORRELATION','TOP SETUPS','SETUPS','INTERMARKET READ','INTERMARKET','BOTTOM LINE','COACHING','COACH','DAILY EDGE','DAILY EDUCATION','EDUCATION','EDGE'];var sk=Object.keys(sec),um=[];for(var i=0;i<sk.length;i++){var found=false;for(var j=0;j<matched.length;j++){if(sk[i]===matched[j]||sk[i].indexOf(matched[j])>=0||matched[j].indexOf(sk[i])>=0){found=true;break;}}if(!found&&sec[sk[i]])um.push(sk[i]);}
    if(um.length){var dh='<h3 style="color:#7d8590">Unmatched Opus Sections</h3>';for(var i=0;i<um.length;i++)dh+='<div class="info-box" style="border-color:#30363d"><p class="dim" style="font-size:11px">'+e(um[i])+'</p><p style="font-size:12px">'+fmt(sec[um[i]])+'</p></div>';$('sCoach').innerHTML+= dh;}}
  $('foot').innerHTML='THE SYSTEM PROTECTS YOU. FOLLOW IT.<br><small>V9 Dashboard ¬∑ '+sL(d.phase)+' ¬∑ GP-'+(d.gpLetter||'C')+(d._timing?' ¬∑ <span class="dim">'+e(d._timing)+'</span>':'')+'</small>';
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function parseN(t){var s={},l=t.split('\n'),k='',b=[];for(var i=0;i<l.length;i++){var li=l[i],m=li.match(/^#{1,3}\s*\**\s*(?:\d+[\.\)]\s*)?(.+?)\s*\**\s*$/);if(m){if(k)s[k]=b.join('\n').trim();k=m[1].toUpperCase().replace(/[:#*_]/g,'').replace(/\s+/g,' ').trim();b=[];}else b.push(li);}if(k)s[k]=b.join('\n').trim();return s;}
function gN(sec,keys){for(var i=0;i<keys.length;i++){var v=sec[keys[i]];if(v)return v;}
  // Fuzzy match: check if any sec key CONTAINS any of our search keys
  var sk=Object.keys(sec);for(var i=0;i<keys.length;i++){for(var j=0;j<sk.length;j++){if(sk[j].indexOf(keys[i])>=0||keys[i].indexOf(sk[j])>=0){if(sec[sk[j]])return sec[sk[j]];}}}return'';}
function fmt(t){if(!t)return'';var h=e(t);h=h.replace(/\*\*(.+?)\*\*/g,'<span class="white bold">$1</span>');h=h.replace(/\$([A-Z]{1,5})/g,function(m,tk){return'<a href="https://www.tradingview.com/chart/?symbol='+tk+'" target="_blank" style="color:#58a6ff;font-weight:700;text-decoration:none">$'+tk+'</a>';});h=h.replace(/\n/g,'<br>');return h;}

poll();setInterval(poll,60000);
</script>
</body>
</html>
