<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0e14">
<title>V9 Trading Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#0b0e14;color:#c4cad4;font-family:'DM Sans',-apple-system,sans-serif;font-size:14px;line-height:1.55;padding:12px;max-width:720px;margin:0 auto;-webkit-text-size-adjust:100%}
  h1{font-family:'JetBrains Mono',monospace;color:#58a6ff;font-size:17px;letter-spacing:-0.3px;padding-bottom:8px;margin-bottom:10px;border-bottom:1px solid #1c2333}
  h2{color:#e6edf3;font-size:15px;font-weight:700;margin-top:22px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
  h2::before{content:'';width:3px;height:16px;background:#58a6ff;border-radius:2px;flex-shrink:0}
  h3{color:#7d8590;font-size:11px;font-weight:700;margin-top:14px;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
  p{margin-bottom:8px}a{color:#58a6ff;text-decoration:none}
  .g{color:#3fb950}.r{color:#f85149}.y{color:#d29922}.b{color:#58a6ff}
  .dim{color:#7d8590}.bold{font-weight:700}.white{color:#e6edf3}
  .mono{font-family:'JetBrains Mono',monospace}
  .tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700}
  .tag-gp{font-family:'JetBrains Mono',monospace;font-size:13px;padding:5px 14px;border-radius:6px}
  .tag-gp-a{background:#0d2818;color:#3fb950;border:1px solid #238636}
  .tag-gp-b{background:#1a1d0f;color:#d29922;border:1px solid #9e6a03}
  .tag-gp-c{background:#161b22;color:#7d8590;border:1px solid #30363d}
  .tag-gp-d{background:#1f1315;color:#f85149;border:1px solid #da3633}
  .tag-live{background:#0d2818;color:#3fb950;border:1px solid #238636;font-size:10px;padding:1px 6px}
  .tag-acct{background:#161b22;color:#7d8590;border:1px solid #30363d;font-size:10px;padding:1px 6px}
  .gp-box{background:linear-gradient(135deg,#0f1923 0%,#131d2b 100%);border:1px solid #1c2333;padding:14px 16px;border-radius:8px;margin-bottom:6px}
  .story-box{background:#0f1318;border-left:3px solid #58a6ff;padding:12px 16px;margin:8px 0;border-radius:0 6px 6px 0;font-size:13px;line-height:1.7}
  .info-box{background:#0f1318;border:1px solid #1c2333;padding:12px 16px;border-radius:6px;margin:8px 0}
  .warn-box{background:#1f1315;border-left:3px solid #f85149;padding:10px 16px;margin:8px 0;border-radius:0 6px 6px 0}
  .alert-box{background:#0f1318;border-left:3px solid #d29922;padding:10px 16px;margin:8px 0;border-radius:0 6px 6px 0;font-size:13px}
  .heat-box{background:#0f1318;border-left:3px solid #3fb950;padding:10px 16px;margin:8px 0;border-radius:0 6px 6px 0;font-size:13px}
  .learn-box{background:#13111a;border-left:3px solid #d2a8ff;padding:14px 16px;border-radius:0 8px 8px 0;margin:8px 0}
  .coaching{color:#d2a8ff;font-style:italic;font-size:13px}
  .risk-card{background:#0f1318;border:1px solid #1c2333;border-radius:8px;padding:12px 16px;margin:8px 0}
  table{width:100%;border-collapse:collapse;margin:6px 0 10px 0;font-size:13px}
  th{background:#0f1318;color:#7d8590;text-align:left;padding:5px 8px;border-bottom:1px solid #1c2333;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
  td{padding:5px 8px;border-bottom:1px solid #161b22;vertical-align:top}
  tr:hover{background:#0f1318}.tc{white-space:nowrap}
  .heatmap{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin:8px 0}
  .hm-hot2,.hm-hot1,.hm-flat,.hm-cold1,.hm-cold2,.hm-cold3{padding:8px 6px;border-radius:4px;text-align:center;font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace}
  .hm-hot2{background:#0a2e15;color:#56d364}.hm-hot1{background:#0a2610;color:#7ee787}
  .hm-flat{background:#161b22;color:#7d8590}.hm-cold1{background:#1f1315;color:#ffa198}
  .hm-cold2{background:#2c1519;color:#f85149}.hm-cold3{background:#3d1519;color:#ff7b72}
  .tracker{display:flex;gap:3px;align-items:flex-end;margin:6px 0;height:40px}
  .tracker-bar{flex:1;border-radius:2px 2px 0 0;min-width:16px}
  .score-big{font-family:'JetBrains Mono',monospace;font-size:32px;font-weight:700}
  .divider{border:0;border-top:1px solid #1c2333;margin:20px 0}
  .footer{text-align:center;color:#30363d;font-size:11px;margin-top:24px;font-family:'JetBrains Mono',monospace}
  .pos-block{border-bottom:1px solid #161b22;padding:8px 0}.pos-block:last-child{border-bottom:0}
  .gauge{display:flex;align-items:center;gap:8px;margin:4px 0}
  .gauge-bar{flex:1;height:8px;background:#161b22;border-radius:4px;overflow:hidden}
  .gauge-fill{height:100%;border-radius:4px}
  .gauge-label{font-size:11px;font-family:'JetBrains Mono',monospace;min-width:40px;text-align:right}
  .status-bar{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:#161b22;border-radius:6px;font-size:11px;margin-bottom:8px}
  .pulse{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
  .pulse-live{background:#3fb950;animation:pulse 2s infinite}.pulse-stale{background:#d29922}.pulse-off{background:#f85149}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
  .narrative-section{background:#0f1318;border-left:3px solid #d2a8ff;padding:12px 16px;margin:8px 0;border-radius:0 6px 6px 0;font-size:13px;line-height:1.7}
  .news-item{padding:8px 10px;border-bottom:1px solid #161b22}
  .news-item a{color:#e6edf3;font-size:13px;line-height:1.5}.news-item a:hover{color:#58a6ff}
  .news-meta{font-size:11px;color:#7d8590;margin-top:3px}
  .news-src{color:#58a6ff}.news-time{margin-left:6px}.news-item.stale{opacity:0.35}
  @media(max-width:480px){body{padding:8px;font-size:13px}.heatmap{grid-template-columns:repeat(3,1fr)}table{font-size:12px}}
</style>
</head>
<body>
<div class="status-bar" id="statusBar"><div><span class="pulse pulse-off" id="pulseLight"></span><span id="statusText">Connecting...</span></div><div id="lastUpdate" class="mono">--:--</div></div>
<h1 id="header">ðŸ“¡ V9 Trading Dashboard</h1>
<p class="dim" style="font-size:12px;margin-top:-8px" id="subHeader">Loading...</p>
<div id="secGameplan"></div>
<div id="secBreadth"></div>
<div id="secSession"></div>
<div id="secGrowth"></div>
<div id="secDefensive"></div>
<div id="secStory"></div>
<div id="secInverse"></div>
<div id="secNews"></div>
<div id="secEarnings"></div>
<hr class="divider">
<div id="secPositions"></div>
<div id="secWatching"></div>
<div id="secRisk"></div>
<div id="secRatios"></div>
<div id="secBreadthDetail"></div>
<hr class="divider">
<div id="secCoaching"></div>
<div class="footer" id="footer">THE SYSTEM PROTECTS YOU. FOLLOW IT.<br><small>V9 Dashboard Â· Live Â· Polling 60s</small></div>

<script>
var ENDPOINT='https://script.google.com/macros/s/AKfycbyA45O4vPIEOTdOW601PmdkdnOpTDSzu44qaSPq-PDBhElHlzThmyqdvD8MO7IZqmLq/exec';
var POLL=60000,_data=null,_lastFetch=0,_fetchCount=0,_errors=0;
var SN={SOXX:'Semis',SMH:'Semis',XLK:'Tech',XLY:'Cons Disc',XLF:'Financials',XLI:'Industrials',XLC:'Comm Svcs',IWM:'Small Cap',XLU:'Utilities',XLP:'Staples',XLV:'Healthcare',XLE:'Energy',XLB:'Materials'};
function $(id){return document.getElementById(id)}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function pct(v){var s=String(v||'');var n=parseFloat(s.replace('%',''));if(isNaN(n))return'<span class="dim">â€”</span>';if(Math.abs(n)<0.5&&s.indexOf('%')<0)n=n*100;var c=n>0.01?'g':n<-0.01?'r':'dim';return'<span class="'+c+'">'+(n>0?'+':'')+n.toFixed(2)+'%</span>'}
function plC(v){var n=parseFloat(String(v).replace(/[$,+]/g,''));return n>0?'g':n<0?'r':'dim'}
function timeAgo(epoch){if(!epoch)return'';var s=Math.floor(Date.now()/1000)-epoch;if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';if(s<86400)return Math.floor(s/3600)+'h';return Math.floor(s/86400)+'d'}
function hmClass(v){if(v>=2)return'hm-hot2';if(v>=0.5)return'hm-hot1';if(v>-0.5)return'hm-flat';if(v>-1.5)return'hm-cold1';if(v>-2.5)return'hm-cold2';return'hm-cold3'}
function barColor(s){var n=parseFloat(s);if(n>=9.5)return'#3fb950';if(n>=3)return'#d29922';if(n>=-3)return'#7d8590';return'#f85149'}
function barH(s){var n=parseFloat(s);return Math.min(100,Math.max(10,(n+10)/20*100))+'%'}
function sL(p){return{PM:'Pre-Market',OPEN:'Morning',CORE:'Core',AH:'After Hours',OFF:'Closed'}[p]||p}
function gS(d,n){return(d.market&&d.market[n])||[]}
function fS(a,s){for(var i=0;i<a.length;i++)if(a[i].sym===s)return a[i];return null}
function poll(){
  fetch(ENDPOINT+'?mode=dashboard&t='+Date.now()).then(function(r){if(!r.ok)throw new Error(r.status);return r.json()}).then(function(d){
    _data=d;_lastFetch=Date.now();_fetchCount++;_errors=0;render(d);
    $('pulseLight').className='pulse pulse-live';$('statusText').textContent='Live Â· #'+_fetchCount;
    $('lastUpdate').textContent=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:'America/Phoenix'});
  }).catch(function(e){_errors++;$('pulseLight').className='pulse pulse-'+(_errors>3?'off':'stale');$('statusText').textContent='Error'+(_errors>1?' (Ã—'+_errors+')':'');});
}
function render(d){renderHeader(d);renderGameplan(d);renderBreadth(d);renderSession(d);renderSectors(d);renderStory(d);renderInverse(d);renderNews(d);renderEarnings(d);renderPositions(d);renderWatching(d);renderRisk(d);renderRatios(d);renderBreadthDetail(d);renderCoaching(d);renderFooter(d);}

function renderHeader(d){var now=new Date();var dn=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];var mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];$('header').innerHTML='ðŸ“¡ V9 Dashboard â€” '+dn[now.getDay()]+' '+mn[now.getMonth()]+' '+now.getDate()+' Â· '+sL(d.phase);$('subHeader').innerHTML='GP-'+(d.gpLetter||'C')+' Â· Score: '+(d.breadthScore||'â€”')+' Â· '+(d.enabled?'<span class="g">Scanner ON</span>':'<span class="r">Scanner OFF</span>');}

function renderGameplan(d){
  var gp=d.gpLetter||'C',score=d.breadthScore||'â€”',sp=d.sectorPts||'â€”';
  var lab={A:'Hunt Mode Â· $15-20K',B:'Sniper Mode Â· $8-12K',C:'Bench Mode Â· No Trades',D:'Short Mode Â· Inverse ETFs'};
  var h='<h2>Gameplan</h2><div class="gp-box"><span class="tag tag-gp tag-gp-'+gp.toLowerCase()+'">GP-'+gp+' Â· '+score+' pts Â· '+sL(d.phase)+'</span>';
  h+='<p style="margin-top:8px" class="white bold">'+esc(lab[gp]||'')+'</p>';
  var bench=gS(d,'BENCHMARKS');var spy=fS(bench,'SPY'),qqq=fS(bench,'QQQ');
  var bd=gS(d,'BREADTH DETAIL').concat(gS(d,'INTERNALS'));var vix=fS(bd,'$VIX');
  h+='<p class="dim" style="font-size:13px">';if(spy)h+='SPY '+esc(spy.val)+' ('+pct(spy.chg)+') Â· ';if(qqq)h+='QQQ '+esc(qqq.val)+' ('+pct(qqq.chg)+') Â· ';if(vix)h+='VIX '+esc(vix.val);h+='</p>';
  h+='<p class="dim" style="font-size:13px">Breadth: '+esc(score)+' Â· Sectors: '+esc(sp)+'</p>';
  var hist=d.history||[];
  if(hist.length>0){h+='<table style="margin-top:8px;font-size:12px"><tr><th>Time</th><th>GP</th><th>Score</th></tr>';var r=hist.slice(-8);for(var i=0;i<r.length;i++){var sc=parseFloat(r[i].score)||0;var cls=sc>=9.5?'g':sc>=3?'y':sc>=-3?'dim':'r';var last=i===r.length-1;h+='<tr'+(last?' style="font-weight:700"':'')+'><td class="dim">'+esc(r[i].time||'')+'</td><td class="'+cls+' bold">'+esc(r[i].gp||'')+'</td><td class="'+cls+'">'+sc.toFixed(1)+'</td></tr>';}h+='</table>';}
  h+='</div>';$('secGameplan').innerHTML=h;
}

function renderBreadth(d){
  var score=parseFloat(d.breadthScore)||0;var hist=d.history||[];
  var cls=score>=9.5?'g':score>=3?'y':score>=-3?'dim':'r';
  var trend=score>=9.5?'â–² Strong':score>=3?'â–² Positive':score>=-3?'â—† Neutral':'â–¼ Negative';
  var h='<h2>Breadth Tracker</h2><div class="info-box"><p><span class="score-big '+cls+'">'+score.toFixed(1)+'</span> <span class="dim" style="font-size:14px">Â· <span class="'+cls+' bold">'+trend+'</span></span></p>';
  if(hist.length>1){var r=hist.slice(-10);h+='<div class="tracker" style="margin-top:10px">';for(var i=0;i<r.length;i++){var s=parseFloat(r[i].score)||0;h+='<div class="tracker-bar" style="height:'+barH(s)+';background:'+barColor(s)+'"></div>';}h+='</div><div style="display:flex;justify-content:space-between;font-size:9px;color:#484f58">';for(var i=0;i<r.length;i++){var t=r[i].time||'';var p=t.split(' ');h+='<span>'+esc(p[p.length-1]||t)+'</span>';}h+='</div>';}
  h+='</div>';$('secBreadth').innerHTML=h;
}

function renderSession(d){
  var bench=gS(d,'BENCHMARKS');var fut=gS(d,'FUTURES');var comm=gS(d,'COMMODITIES');
  if(!bench.length&&!fut.length){$('secSession').innerHTML='';return}
  var h='<h2>Session Stats</h2><div class="info-box"><table><tr><th>Ticker</th><th>Last</th><th>Chg %</th></tr>';
  var keys=['SPY','QQQ','DIA','IWM'];for(var k=0;k<keys.length;k++){var it=fS(bench,keys[k]);if(it)h+='<tr><td class="white bold tc">'+esc(it.sym)+'</td><td class="mono">'+esc(it.val)+'</td><td>'+pct(it.chg)+'</td></tr>';}
  var bd=gS(d,'BREADTH DETAIL').concat(gS(d,'INTERNALS'));var vix=fS(bd,'$VIX'),dxy=fS(bd,'$DXY');
  if(vix)h+='<tr><td class="y bold tc">$VIX</td><td class="mono">'+esc(vix.val)+'</td><td>'+pct(vix.chg)+'</td></tr>';
  if(dxy)h+='<tr><td class="dim tc">$DXY</td><td class="mono">'+esc(dxy.val)+'</td><td>'+pct(dxy.chg)+'</td></tr>';
  for(var c=0;c<comm.length;c++)h+='<tr><td class="dim tc">'+esc(comm[c].sym)+'</td><td class="mono">'+esc(comm[c].val)+'</td><td>'+pct(comm[c].chg)+'</td></tr>';
  if(fut.length>0){h+='<tr><td colspan="3" style="font-size:11px;color:#7d8590;padding-top:8px;border:none">FUTURES</td></tr>';for(var f=0;f<fut.length;f++)h+='<tr><td class="dim tc">'+esc(fut[f].sym)+'</td><td class="mono">'+esc(fut[f].val)+'</td><td>'+pct(fut[f].chg)+'</td></tr>';}
  h+='</table></div>';$('secSession').innerHTML=h;
}

function renderSectors(d){
  var hm=d.sectorHeatmap||[];
  var gr=hm.filter(function(x){return x.type==='G'}).sort(function(a,b){return b.chg-a.chg});
  var df=hm.filter(function(x){return x.type==='D'}).sort(function(a,b){return b.chg-a.chg});
  var gg=gr.filter(function(x){return x.chg>0.05}).length;
  var dg=df.filter(function(x){return x.chg>0.05}).length;
  var h='<h2>Sectors â€” Growth ('+gg+'/'+gr.length+' Green)</h2><div class="heatmap">';
  for(var i=0;i<gr.length;i++){var nm=SN[gr[i].sym]||gr[i].name||'';h+='<div class="'+hmClass(gr[i].chg)+'">'+esc(gr[i].sym)+'<br>'+(gr[i].chg>0?'+':'')+gr[i].chg.toFixed(2)+'%'+(nm?'<br><span style="font-size:9px;opacity:0.7">'+esc(nm)+'</span>':'')+'</div>';}
  h+='</div>';
  if(gr.length>0){var l=gr[0],g=gr[gr.length-1];h+='<div class="heat-box" style="border-color:'+(gg>gr.length/2?'#3fb950':'#f85149')+'"><span class="g bold">Leading:</span> '+esc(l.sym)+' '+(l.chg>0?'+':'')+l.chg.toFixed(2)+'% Â· <span class="r bold">Lagging:</span> '+esc(g.sym)+' '+(g.chg>0?'+':'')+g.chg.toFixed(2)+'%</div>';}
  $('secGrowth').innerHTML=h;
  var hd='<h2>Sectors â€” Defensive ('+dg+'/'+df.length+' Green)</h2><div class="heatmap" style="grid-template-columns:repeat('+Math.min(df.length,5)+',1fr)">';
  for(var i=0;i<df.length;i++){var nm=SN[df[i].sym]||df[i].name||'';hd+='<div class="'+hmClass(df[i].chg)+'">'+esc(df[i].sym)+'<br>'+(df[i].chg>0?'+':'')+df[i].chg.toFixed(2)+'%'+(nm?'<br><span style="font-size:9px;opacity:0.7">'+esc(nm)+'</span>':'')+'</div>';}
  hd+='</div>';$('secDefensive').innerHTML=hd;
}

function renderStory(d){
  var nar=d.dashboardNarrative||'';if(!nar){$('secStory').innerHTML='<h2>The Story</h2><div class="info-box"><p class="dim">No Opus narrative yet. Run ðŸ“¡ Dashboard Now from scanner menu.</p></div>';return}
  var sec=parseN(nar);var ts=d.dashboardTimestamp||'';
  var h='<h2>The Story</h2><p class="dim" style="font-size:11px">Opus Â· '+esc(ts)+' Â· '+(d.dashboardSession||'')+'</p>';
  var story=sec['THE STORY']||sec['STORY']||'';if(story)h+='<div class="story-box">'+fmt(story)+'</div>';
  var gps=sec['GAMEPLAN STATUS']||sec['GAMEPLAN']||'';if(gps)h+='<h3>Gameplan Status</h3><div class="info-box" style="font-size:13px;line-height:1.7">'+fmt(gps)+'</div>';
  var pa=sec['POSITION ALERTS']||sec['POSITIONS']||'';if(pa)h+='<h3>Position Alerts</h3><div class="alert-box">'+fmtPA(pa)+'</div>';
  var cc=sec['CORRELATION CHECK']||sec['CORRELATION']||'';if(cc)h+='<h3>Correlation / Risk</h3><div class="info-box" style="font-size:13px">'+fmt(cc)+'</div>';
  var ts2=sec['TOP SETUPS']||sec['SETUPS']||'';if(ts2)h+='<h3>Top Setups</h3><div class="info-box" style="font-size:13px">'+fmt(ts2)+'</div>';
  if(!story&&!gps&&!pa)h+='<div class="narrative-section">'+fmt(nar)+'</div>';
  $('secStory').innerHTML=h;
}

function renderInverse(d){if((d.gpLetter||'C')!=='D'){$('secInverse').innerHTML='';return}var inv=gS(d,'INVERSE ETFs (GP-D)');if(!inv.length){$('secInverse').innerHTML='';return}var h='<h2 style="color:#f85149">Inverse ETFs â€” GP-D</h2><div class="info-box"><table><tr><th>ETF</th><th>Last</th><th>Chg%</th><th>Tracks</th></tr>';for(var i=0;i<inv.length;i++)h+='<tr><td class="r bold tc">'+esc(inv[i].sym)+'</td><td>'+esc(inv[i].val)+'</td><td>'+pct(inv[i].chg)+'</td><td class="dim">'+esc(inv[i].desc)+'</td></tr>';h+='</table></div>';$('secInverse').innerHTML=h;}

function renderNews(d){var news=d.news||[];if(!news.length){$('secNews').innerHTML='';return}var h='<h2 style="color:#d29922">Market News ('+news.length+')</h2><div class="info-box" style="padding:0">';for(var i=0;i<Math.min(news.length,25);i++){var n=news[i];var age=timeAgo(n.time);var stale=(Date.now()/1000-(n.time||0))>7200;var src=n.source||n.feed||'';var ft=n.feed||'';h+='<div class="news-item'+(stale?' stale':'')+'"><a href="'+esc(n.url)+'" target="_blank">'+esc(n.headline)+'</a><div class="news-meta"><span class="news-src">'+esc(src)+'</span>'+(ft&&ft!==src?' <span style="color:#484f58">['+esc(ft)+']</span>':'')+'<span class="news-time">'+age+'</span>'+(n.related?' <span class="y bold" style="font-size:10px">'+esc(n.related)+'</span>':'')+'</div></div>';}h+='</div>';$('secNews').innerHTML=h;}

function renderEarnings(d){var e=d.earnings||[];if(!e.length){$('secEarnings').innerHTML='';return}var h='<h2>Earnings This Week</h2><div class="info-box"><table><tr><th>Day</th><th>Time</th><th>Ticker</th><th>Note</th></tr>';for(var i=0;i<e.length;i++)h+='<tr><td class="dim">'+esc(e[i].day)+'</td><td class="dim">'+esc(e[i].time)+'</td><td class="white bold tc">'+esc(e[i].symbol)+'</td><td class="dim">'+esc(e[i].note)+'</td></tr>';h+='</table></div>';$('secEarnings').innerHTML=h;}

function renderPositions(d){
  var pos=d.positions||[];if(!pos.length){$('secPositions').innerHTML='<h2><span class="tag tag-live">YOUR BOOK</span> Active Positions</h2><div class="info-box"><p class="dim">No positions loaded.</p></div>';return}
  var h='<h2><span class="tag tag-live">YOUR BOOK</span> Active Positions ('+pos.length+')</h2><div class="info-box">';
  for(var i=0;i<pos.length;i++){var p=pos[i];
    h+='<div class="pos-block"><div style="display:flex;justify-content:space-between;align-items:center">';
    h+='<span><span class="white bold" style="font-size:15px">'+esc(p.ticker)+'</span>';
    if(p.accountType)h+=' <span class="tag tag-acct">'+esc(p.accountType)+'</span>';
    if(p.tag)h+=' <span class="tag" style="background:#13111a;color:#d2a8ff;border:1px solid #2d1f4e">'+esc(p.tag)+'</span>';
    h+='</span><span class="'+plC(p.totalPL)+' bold mono" style="font-size:14px">'+esc(p.totalPL)+'</span></div>';
    h+='<p style="font-size:12px;color:#7d8590;margin:2px 0">'+esc(p.side)+' '+esc(p.shares)+'sh @ $'+esc(p.avgCost)+' â†’ $'+esc(p.last)+'</p>';
    h+='<p style="font-size:12px;margin:0">Day: <span class="'+plC(p.dayPL)+' bold">'+esc(p.dayPL)+' ('+esc(p.dayPLPct)+')</span> Â· Total: <span class="'+plC(p.totalPL)+' bold">'+esc(p.totalPLPct)+'</span></p></div>';
  }
  h+='</div>';
  var ac=d.areteCarries||[];var aw=d.areteWatching||[];
  if(ac.length>0||aw.length>0){
    h+='<h3 style="margin-top:14px;color:#d29922">Arete Radar</h3><div class="info-box" style="font-size:12px;border-color:#9e6a03">';
    h+='<p class="dim" style="font-size:11px;margin-bottom:6px">Arete Discord â€” not your positions unless also shown above.</p>';
    if(ac.length>0){h+='<p><span class="y bold">Carries/Swings:</span> '+ac.map(function(a){return'<span class="white">'+esc(a.ticker)+'</span>'+(a.level?' <span class="dim">'+esc(a.level)+'</span>':'')}).join(' Â· ')+'</p>';}
    if(aw.length>0){h+='<p><span class="y bold">Watching:</span> <span class="dim">'+aw.map(esc).join(', ')+'</span></p>';}
    h+='</div>';
  }
  $('secPositions').innerHTML=h;
}

function renderWatching(d){
  var w=d.watchlistTop||[];if(!w.length){$('secWatching').innerHTML='';return}
  var h='<h2>Top Confluence ('+w.length+')</h2><div class="info-box"><table><tr><th>Ticker</th><th>Last</th><th>Chg%</th><th>Conf</th><th>Qual</th><th>Setup</th><th>Section</th></tr>';
  for(var i=0;i<Math.min(w.length,15);i++){var it=w[i];var cc=it.confluence>=28?'g':it.confluence>=24?'y':'dim';
    h+='<tr><td class="white bold tc">'+esc(it.ticker)+'</td><td>'+esc(it.last)+'</td><td>'+pct(it.chg)+'</td><td class="'+cc+' bold mono">'+it.confluence.toFixed(1)+'</td><td class="dim">'+esc(it.quality)+'</td><td class="dim">'+esc(it.setup)+'</td><td class="dim" style="font-size:11px">'+esc(it.section)+'</td></tr>';}
  h+='</table></div>';$('secWatching').innerHTML=h;
}

function renderRisk(d){
  var pos=d.positions||[];if(!pos.length){$('secRisk').innerHTML='';return}
  var tMV=0,tDay=0,tUn=0,tags={},longs=0,shorts=0;
  for(var i=0;i<pos.length;i++){var p=pos[i];var mv=parseFloat(String(p.mktValue||'0').replace(/[$,+]/g,''))||0;var dp=parseFloat(String(p.dayPL||'0').replace(/[$,+]/g,''))||0;var tp=parseFloat(String(p.totalPL||'0').replace(/[$,+]/g,''))||0;tMV+=Math.abs(mv);tDay+=dp;tUn+=tp;if(p.side==='Long')longs++;else shorts++;var t=p.tag||p.accountType||'Untagged';if(!tags[t])tags[t]={count:0,tickers:[]};tags[t].count++;tags[t].tickers.push(p.ticker);}
  var h='<h2>Risk Dashboard</h2><div class="risk-card">';
  h+='<p><span class="white bold">Positions:</span> '+pos.length+' ('+longs+'L / '+shorts+'S) Â· <span class="bold">Limit: 5</span></p>';
  h+='<p><span class="white bold">Exposure:</span> $'+tMV.toLocaleString('en-US',{maximumFractionDigits:0})+'</p>';
  h+='<p><span class="white bold">Day P&L:</span> <span class="'+plC(tDay)+' bold">'+(tDay>=0?'+$':'-$')+Math.abs(tDay).toFixed(2)+'</span></p>';
  h+='<p><span class="white bold">Unrealized:</span> <span class="'+plC(tUn)+' bold">'+(tUn>=0?'+$':'-$')+Math.abs(tUn).toFixed(2)+'</span></p>';
  var tk=Object.keys(tags);if(tk.length>0){h+='<h3 style="margin-top:10px">Concentration</h3>';for(var i=0;i<tk.length;i++){var pB=Math.round(tags[tk[i]].count/pos.length*100);var wc=pB>50?'#f85149':pB>30?'#d29922':'#3fb950';h+='<div class="gauge"><span class="dim" style="min-width:70px;font-size:12px">'+esc(tk[i])+'</span><div class="gauge-bar"><div class="gauge-fill" style="width:'+pB+'%;background:'+wc+'"></div></div><span class="gauge-label" style="color:'+wc+'">'+pB+'% <span class="dim">('+tags[tk[i]].tickers.join(',')+')</span></span></div>';}}
  if(pos.length>=5)h+='<div class="warn-box" style="margin-top:8px"><span class="r bold">âš  At 5-position limit.</span> Close before adding.</div>';
  h+='</div>';$('secRisk').innerHTML=h;
}

function renderRatios(d){
  var r=gS(d,'INTERMARKET RATIOS');if(!r.length){$('secRatios').innerHTML='';return}
  var h='<h2>Intermarket Ratios</h2><div class="info-box"><table><tr><th>Pair</th><th>Value</th><th>Chg</th><th>Signal</th></tr>';
  for(var i=0;i<r.length;i++){var cn=parseFloat(String(r[i].chg).replace('%',''));var desc=r[i].desc||'';var sig='';
    if(desc.indexOf('rising')>=0&&desc.indexOf('falling')>=0){if(cn>0.01)sig=desc.split('rising')[1].split(',')[0].replace(/[=â€”]/g,'').trim();else if(cn<-0.01)sig=desc.split('falling')[1].split(',')[0].replace(/[=â€”]/g,'').trim();else sig='flat';}else{sig=desc.indexOf('â€”')>=0?desc.split('â€”').slice(1).join('â€”').trim():desc;}
    h+='<tr><td class="white bold tc">'+esc(r[i].sym)+'</td><td class="mono">'+esc(r[i].val)+'</td><td>'+pct(r[i].chg)+'</td><td class="dim" style="font-size:12px">'+esc(sig)+'</td></tr>';}
  h+='</table></div>';$('secRatios').innerHTML=h;
}

function renderBreadthDetail(d){
  var bd=gS(d,'BREADTH DETAIL');var it=gS(d,'INTERNALS');
  var items=bd.concat(it).filter(function(x){return x.sym!=='$VIX'&&x.sym!=='$DXY'});
  if(!items.length){$('secBreadthDetail').innerHTML='';return}
  var h='<h2>Breadth Detail</h2><div class="info-box"><table><tr><th>Indicator</th><th>Value</th><th>Signal</th></tr>';
  for(var i=0;i<items.length;i++){var desc=items[i].desc||'';var ins=desc.indexOf('â€”')>=0?desc.split('â€”').slice(1).join('â€”').trim():desc;
    h+='<tr><td class="white bold tc">'+esc(items[i].sym)+'</td><td class="mono">'+esc(items[i].val)+'</td><td class="dim" style="font-size:12px">'+esc(ins)+'</td></tr>';}
  h+='</table></div>';$('secBreadthDetail').innerHTML=h;
}

function renderCoaching(d){var nar=d.dashboardNarrative||'';if(!nar){$('secCoaching').innerHTML='';return}var sec=parseN(nar);var c=sec['COACHING']||sec['BEHAVIORAL COACHING']||'';if(!c){$('secCoaching').innerHTML='';return}$('secCoaching').innerHTML='<h2>ðŸ“š Coaching</h2><div class="learn-box"><p class="coaching">'+fmt(c)+'</p></div>';}

function renderFooter(d){var now=new Date();var dn=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];var mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];$('footer').innerHTML='THE SYSTEM PROTECTS YOU. FOLLOW IT.<br><small>V9 Dashboard Â· '+sL(d.phase)+' Â· '+dn[now.getDay()]+' '+mn[now.getMonth()]+' '+now.getDate()+' Â· GP-'+(d.gpLetter||'C')+'</small>';}

function parseN(text){var s={},lines=text.split('\n'),key='',buf=[];for(var i=0;i<lines.length;i++){var m=lines[i].match(/^#{1,3}\s*\**\s*(\d+\.\s*)?(.+?)\s*\**\s*$/);if(m){if(key)s[key]=buf.join('\n').trim();key=m[2].toUpperCase().replace(/[:#*]/g,'').trim();buf=[];}else buf.push(lines[i]);}if(key)s[key]=buf.join('\n').trim();return s;}
function fmt(t){if(!t)return'';var h=esc(t);h=h.replace(/\*\*(.+?)\*\*/g,'<span class="white bold">$1</span>');h=h.replace(/\$([A-Z]{1,5})/g,'<span class="b bold">$$$1</span>');h=h.replace(/\n/g,'<br>');return h;}
function fmtPA(text){if(!text)return'';var lines=text.split('\n').filter(function(l){return l.trim()&&l.indexOf('---')<0&&l.indexOf('Position')<0&&l.indexOf('Action')<0});if(!lines.length)return fmt(text);var hasT=lines.some(function(l){return l.indexOf('|')>=0&&l.split('|').length>=3});if(!hasT)return fmt(text);var h='<table style="font-size:12px"><tr><th>Ticker</th><th>Status</th><th>Action</th></tr>';for(var i=0;i<lines.length;i++){var p=lines[i].split('|').map(function(x){return x.trim()}).filter(function(x){return x});if(p.length<2)continue;var tk=p[0].replace(/\*\*/g,'');var st=p.length>=2?p[1]:'';var ac=p.length>=4?p[3]:p.length>=3?p[2]:'';var cls=ac.toLowerCase().match(/trim|exit|review|broken|stop/)?'r':ac.toLowerCase().match(/hold|monitor/)?'y':'dim';h+='<tr><td class="white bold tc">'+esc(tk)+'</td><td class="dim">'+esc(st)+'</td><td class="'+cls+' bold">'+esc(ac)+'</td></tr>';}h+='</table>';return h;}

poll();setInterval(poll,POLL);
</script>
</body>
</html>
